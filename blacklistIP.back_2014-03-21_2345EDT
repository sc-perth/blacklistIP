blIP_saveFile="/etc/blacklistIP/blacklistIP_save"

#!/bin/bash

# ERR
# Send error message to stderr
# Usage:
#	ERR code_segment_identifier - error message
#	eg: ERR Vaild_IPv4 - quartet is out of range
function __blacklistIP_ERR { echo "!!! ERROR : $@" 1>&2; }

function __blacklistIP {
case "$1" in
	exists)
		sudo iptables -C BLACKLIST -j RETURN					# Check for return rule in BLACKLIST chain, fails if no rule or chain, both legit failures
		if [ $? -gt 0 ]; then return 1; fi
		sudo iptables -n -L INPUT | grep -q 'BLACKLIST[ \t]'	# Check for jump target in INPUT chain, grep returns 1 if not found
		if [ $? -gt 0 ]; then return 1; fi
		return 0
	;;
	create)
		sudo iptables -N BLACKLIST				# Create new chain
		sudo iptables -A BLACKLIST -j RETURN	# Add return statement at bottom
		sudo iptables -I INPUT 1 -j BLACKLIST	# Insert global jump statement to INPUT chain
		return 0
	;;
	reset)
		sudo iptables -D INPUT -j BLACKLIST		# Remove global jump statement from INPUT chain
		sudo iptables -F BLACKLIST				# Deletes all rules in chain
		sudo iptables -X BLACKLIST				# Deletes the chain
		__blacklistIP create
		return 0
	;;
	usage)	# print usage for _blacklistIP (NOT __blacklistIP)
		echo "Usage: blacklistIP [OPTION]  [ARGUMENT]"
		echo -e "User-friendly front-end to blocking all inbound traffic from specified IPs using iptables\n"
		echo -e "  [OPTION]\t [ARGUMENT]\t Descriptive statement"
		echo -e "  -a --add\t  IP[,IP[,...]]\t Drop/Block incoming connections from IP(s)"
		echo -e "  -d --load\t  --NONE--\t Initializes the iptables and loads the IPs to block from\n\t\t\t\t\t"$blIP_saveFile" (only useful after a reboot)"
		echo -e "  -h --help\t  --NONE--\t Prints help & usage information (this message)"
		echo -e "  -l --list\t  --NONE--\t Prints list of blocked IPs in chain"
		echo -e "  -n --loadnew\t  --NONE--\t Adds any IPs in "$blIP_saveFile" that are not currently in the chain"
		echo -e "  -o --overwrite  --NONE--\t clears all IPs from the chain and loads all IPs in "$blIP_saveFile
		echo -e "  -r --rem\t  IP\t\t Removes IP from chain"
		echo -e "  -s --sort\t  --NONE--\t Sort the IPs in the chain"
		echo -e "  -w --save\t  --NONE--\t Saves the IPs in the chain to "$blIP_saveFile
		return 0
	;;
	*)
		__blacklistIP_ERR "__blacklistIP: invalid argument"
		;;
esac
}

function _blacklistIP {
case "$1" in
	-h | --help)
		__blacklistIP usage
		return 0
	;;
	-a | --add)
		# Check to see if input is a valid IP (also works on multiple, comma seperated IPs; might let bad IPs through if they aren't the first in the list)
		if [[ $2 =~  [0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3} ]]; then
				
			# Check if BLACKLIST chain exists, if not: create it
			__blacklistIP exists
			if [ $? -gt 0 ]; then __blacklistIP create; fi
			
			# Insert supplied IPs into BLACKLIST chain, insert keeps return statement as last rule.
			sudo iptables -I BLACKLIST 1 -s $2 -j DROP
			return 0
		fi
	;;
	-l | --list)
		__blacklistIP exists
		if [[ $? -gt 0 ]]; then
			__blacklistIP_ERR "blacklistIP: IPchain 'BLACKLIST' does not exist."
			return 1
		fi
		sudo iptables -L BLACKLIST --line-numbers -n
	;;
	-r | --rem)
		__blacklistIP exists
		if [[ $? -gt 0 ]]; then
			__blacklistIP_ERR "blacklistIP: IPchain 'BLACKLIST' does not exist."
			return 1
		fi
		# Check to see if input is a valid IP (also works on multiple, comma seperated IPs; might let bad IPs through if they aren't the first in the list)
		if [[ $2 =~  [0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3} ]]; then
			# Check for target
			sudo iptables -C BLACKLIST -s $2 -j DROP
			if [[ $? -gt 0 ]]; then
				__blacklistIP_ERR "blacklistIP: rm: Target does not exist in chain."
				__blacklistIP_ERR "blacklistIP: rm: Target: $2"
				return 1
			fi
			# If target exists, delete it
			sudo iptables -D BLACKLIST -s $2 -j DROP
			return 0
		fi
	;;
	-s | --sort)
		__blacklistIP exists
		if [ $? -gt 0 ]; then 
			__blacklistIP_ERR "blacklistIP: IPchain 'BLACKLIST' does not exist, please create and populate first"
			return 1
		fi
		
		# Does some grep & trim magic to extract current list of banned IPs from BLACKLIST chain, sort them,
		# - and trim them so you end up with a space seperated list of IPs, exactly what you want when declaring a Bash array
		declare -a blIP_iparr=($( sudo iptables -n -L BLACKLIST | tr '\n' ' ' | grep "Chain BLACKLIST.*" | egrep -o "[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}" | grep -v "0.0.0.0" | sort -V | tr '\n' ' ' ));
		
		# Set bounds for parsing the array
		local iter=0
		local end=${#blIP_iparr[@]}

		__blacklistIP reset						# Clear the blacklist
		sudo iptables -D BLACKLIST -j RETURN	# Remove return statement, We'll add it back in at the end
		while [ $iter -lt $end ]; do			# Iterate through and add the sorted IPs back in
			sudo iptables -A BLACKLIST -s ${blIP_iparr[$iter]} -j DROP
			let iter+=1
		done
		sudo iptables -A BLACKLIST -j RETURN	# Add the return statement to the end of the list
		return 0
	;;
	-w | --save)
		__blacklistIP exists
		if [ $? -gt 0 ]; then 
			__blacklistIP_ERR "blacklistIP: IPchain 'BLACKLIST' does not exist, please create and populate first"
			return 1
		fi
		# If chain exists, parse out desired lines, write them to file
		sudo iptables-save | grep -e "-A.*BLACKLIST.*" | sudo tee $blIP_saveFile 1>/dev/null
		return 0
	;;
	-d | --load)
		# If file exists, and can be read
		if [[ -f $blIP_saveFile && -r $blIP_saveFile ]]; then
			__blacklistIP exists
			if [ $? -eq 0 ]; then
				__blacklistIP_ERR "blacklistIP: IP chain already exists!"
				echo "!!! WARNING : blacklistIP: IPchain already exists! Please use"
				echo -e "\t'blacklistIP --overwrite' which will clear all current rules, and load only the saved rules"
				echo -e "or\t'blacklistIP --loadnew' which will keep all current rules, and only load new rules from the saved rules"
				return 1
			fi
			sudo iptables -N BLACKLIST
			while read file; do
				sudo iptables $file
			done < $blIP_saveFile
		else
			__blacklistIP_ERR "blacklistIP: "$blIP_saveFile" does not exist or is not readable"
			return 1
		fi
	;;
	-o | --overwrite)
		__blacklistIP reset
		local blIP_list=""
		while read line; do
			local line_ip=$( echo $line | grep -Eo "[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}" )
			if [[ $line_ip ]]; then
				blIP_list+="${line_ip},"
			fi
		done < $blIP_saveFile
		_blacklistIP --add $( echo $blIP_list | sed s/".$"// )
		_blacklistIP --sort
	;;
	-n | --loadnew)
		sudo iptables -D BLACKLIST -j RETURN	# Remove return statement, It will be added back in from the end of the save file
		while read line; do
			local rule=$( echo $line | sed s/"-A "// )
			sudo iptables -C $rule
			if [ $? -ne 0 ]; then
				sudo iptables -A $rule
			fi
		done < $blIP_saveFile
		_blacklistIP --sort
	;;
	*)
		__blacklistIP_ERR "blacklistIP: FATAL: invalid arguments"
		__blacklistIP usage
		return 1
	;;
esac
}

# This line allows this script to be placed in /usr/bin/blacklistIP and used at a prompt as a command ("blacklistIP")
_blacklistIP $@
